<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Regent Connect ‚Äî Groups</title>
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/themes.css">
  <style>
    body { background: linear-gradient(180deg,#071126 0%, #071b2a 100%); color: #e6eef8; margin: 0; padding: 0; font-family: Inter, system-ui; }
    
    .nav-toggle {
      position: fixed !important;
      top: 20px !important;
      left: 20px !important;
      z-index: 200 !important;
      background: #8b5cf6 !important;
      color: #fff !important;
      border: none !important;
      width: 48px !important;
      height: 48px !important;
      border-radius: 50% !important;
      cursor: pointer !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      font-size: 1.5em !important;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
      transition: all 0.3s ease !important;
    }
    .nav-toggle:hover { background: #7c3aed !important; transform: scale(1.05) !important; }
    
    .side-nav {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      height: 100vh !important;
      width: 180px !important;
      background: #10172a !important;
      display: flex !important;
      flex-direction: column !important;
      padding-top: 80px !important;
      z-index: 100 !important;
      box-shadow: 2px 0 16px rgba(0,0,0,0.07) !important;
      transform: translateX(0) !important;
      transition: transform 0.3s ease !important;
    }
    .side-nav.hidden { transform: translateX(-180px) !important; }
    .side-nav .nav-btn, .side-nav a.btn { display: flex; align-items: center; gap: 10px; padding: 12px 18px; background: none; border: none; color: #e0e7ef; text-decoration: none; font-size: 1em; border-radius: 0 20px 20px 0; transition: background 0.15s; cursor: pointer; margin-bottom: 2px; }
    .side-nav .nav-btn:hover, .side-nav a.btn:hover { background: #23263a; color: #fff; }
    .side-nav .nav-btn.active, .side-nav a.btn.active { background: #4f46e5; color: #fff; }
    
    .main-content { margin-left: 200px; padding: 40px; max-width: 1000px; transition: margin-left 0.3s ease; }
    .main-content.expanded { margin-left: 20px; }
    .card { background: #181c2a; border-radius: 14px; padding: 24px; margin-bottom: 20px; box-shadow: 0 4px 18px rgba(0,0,0,0.08); }
    .group-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; }
    .group-card { background: #23263a; padding: 20px; border-radius: 12px; }
    .btn { background: #8b5cf6; color: #fff; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 600; }
    .btn:hover { background: #7c3aed; }
    .btn.secondary { background: #353b50; }
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
    .modal.show { display: flex; }
    .modal-content { background: #181c2a; padding: 32px; border-radius: 16px; max-width: 500px; width: 90%; }
    input, textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #353b50; background: #23263a; color: #fff; }
    
    @media (max-width: 700px) {
      .side-nav { width: 250px; }
      .side-nav.hidden { transform: translateX(-250px) !important; }
      .main-content { margin-left: 0; padding: 20px; }
    }
  </style>
</head>
<body>
  <button class="nav-toggle" id="navToggle">‚ò∞</button>

  <nav class="side-nav" id="sideNav">
    <button onclick="history.back()" class="nav-btn">‚¨ÖÔ∏è Back</button>
    <a href="chat.html" class="btn secondary nav-btn">üí¨ Chat</a>
    <a href="friends.html" class="btn secondary nav-btn">üë• Friends</a>
    <a href="groups.html" class="btn secondary nav-btn active">üîó Groups</a>
    <a href="notifications.html" class="btn secondary nav-btn">üîî Notifications</a>
    <a href="profile.html" class="btn secondary nav-btn">üë§ Profile</a>
    <a href="settings.html" class="btn secondary nav-btn">‚öôÔ∏è Settings</a>
  </nav>

  <div class="main-content" id="mainContent">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">
      <h1>üîó Groups</h1>
      <button class="btn" onclick="openCreateModal()">‚ûï Create Group</button>
    </div>
    
    <div class="card">
      <h2>My Groups (<span id="myGroupsCount">0</span>)</h2>
      <div class="group-list" id="myGroups"></div>
    </div>

    <div class="card">
      <h2>All Groups (<span id="allGroupsCount">0</span>)</h2>
      <div class="group-list" id="allGroups"></div>
    </div>
  </div>

  <div id="createModal" class="modal">
    <div class="modal-content">
      <h2>Create New Group</h2>
      <input type="text" id="groupName" placeholder="Group Name" />
      <textarea id="groupDesc" placeholder="Description (optional)" rows="3"></textarea>
      <div style="display:flex;gap:12px;margin-top:16px">
        <button class="btn" onclick="createGroup()">Create</button>
        <button class="btn secondary" onclick="closeModal()">Cancel</button>
      </div>
    </div>
  </div>

  <script src="js/db.js"></script>
  <script src="js/groups.js"></script>
  <script>
    // IMPORTANT: Run navigation toggle FIRST
    (function initNavToggle() {
      console.log('Initializing navigation toggle for groups page');
      
      const navToggle = document.getElementById('navToggle');
      const sideNav = document.getElementById('sideNav');
      const mainContent = document.getElementById('mainContent');
      
      if (!navToggle || !sideNav || !mainContent) {
        console.error('Navigation elements not found');
        return;
      }
      
      navToggle.addEventListener('click', function() {
        console.log('Groups navigation toggle clicked');
        sideNav.classList.toggle('hidden');
        mainContent.classList.toggle('expanded');
        navToggle.textContent = sideNav.classList.contains('hidden') ? '‚ò∞' : '‚úï';
      });
      
      console.log('Navigation toggle initialized successfully');
    })();

    // Then run groups functionality
    (function initGroups() {
      const currentUser = DB.load(KEYS.CURRENT_USER);
      if (!currentUser) {
        window.location.href = 'login.html';
        return;
      }

      const groups = DB.load(KEYS.GROUPS, []);
      
      // Render my groups
      const myGroups = groups.filter(g => g.members.includes(currentUser.id));
      document.getElementById('myGroupsCount').textContent = myGroups.length;
      const myGroupsContainer = document.getElementById('myGroups');
      
      if (myGroups.length === 0) {
        myGroupsContainer.innerHTML = '<p style="color:#a3aed6;text-align:center;padding:40px">You haven\'t joined any groups yet</p>';
      } else {
        myGroups.forEach(group => {
          const div = document.createElement('div');
          div.className = 'group-card';
          const isAdmin = group.admins.includes(currentUser.id);
          div.innerHTML = `
            <h3 style="margin:0 0 8px 0">${group.name} ${isAdmin ? 'üëë' : ''}</h3>
            <p style="color:#a3aed6;font-size:0.9em;margin:0 0 12px 0">${group.members.length} members</p>
            <button class="btn" onclick="location.href='chat.html?group=${group.id}'">üí¨ Open Chat</button>
            ${isAdmin ? `<button class="btn secondary" onclick="manageGroup('${group.id}')" style="margin-left:8px">‚öôÔ∏è Manage</button>` : ''}
          `;
          myGroupsContainer.appendChild(div);
        });
      }

      // Render all groups
      document.getElementById('allGroupsCount').textContent = groups.length;
      const allGroupsContainer = document.getElementById('allGroups');
      
      groups.forEach(group => {
        const isMember = group.members.includes(currentUser.id);
        const div = document.createElement('div');
        div.className = 'group-card';
        div.innerHTML = `
          <h3 style="margin:0 0 8px 0">${group.name}</h3>
          <p style="color:#a3aed6;font-size:0.9em;margin:0 0 12px 0">${group.members.length} members</p>
          ${isMember ? 
            '<span style="color:#10b981">‚úì Joined</span>' :
            `<button class="btn" onclick="requestJoin('${group.id}')">Join Group</button>`
          }
        `;
        allGroupsContainer.appendChild(div);
      });

      // Make functions global
      window.openCreateModal = function() {
        document.getElementById('createModal').classList.add('show');
      };

      window.closeModal = function() {
        document.getElementById('createModal').classList.remove('show');
      };

      window.createGroup = function() {
        const name = document.getElementById('groupName').value.trim();
        if (!name) return alert('Please enter a group name');
        
        const result = Groups.createGroup(name, currentUser.id);
        alert(result.msg);
        if (result.ok) location.reload();
      };

      window.requestJoin = function(groupId) {
        const result = Groups.addMemberToGroup(groupId, currentUser.id, currentUser.id);
        alert(result.msg);
        if (result.ok) location.reload();
      };

      window.manageGroup = function(groupId) {
        alert('Group management feature coming soon!');
      };
    })();
  </script>
</body>
</html>
