<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Regent Connect ‚Äî Chat</title>
  <link rel="stylesheet" href="./css/main.css">
  <link rel="stylesheet" href="./css/chat.css">
  <link rel="stylesheet" href="./css/themes.css">
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#94a3b8;--accent:#4f46e5;--success:#10b981}
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071126 0%, #071b2a 100%);color:#e6eef8}
    
    /* Navigation Toggle - FIXED */
    .nav-toggle {
      position: fixed !important;
      top: 20px !important;
      left: 20px !important;
      z-index: 300 !important;
      background: #8b5cf6 !important;
      color: #fff !important;
      border: none !important;
      width: 48px !important;
      height: 48px !important;
      border-radius: 50% !important;
      cursor: pointer !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      font-size: 1.5em !important;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
      transition: all 0.3s ease !important;
    }
    .nav-toggle:hover { background: #7c3aed !important; transform: scale(1.05) !important; }

    /* Side Navigation - FIXED */
    .side-nav {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      height: 100vh !important;
      width: 180px !important;
      background: #10172a !important;
      display: flex !important;
      flex-direction: column !important;
      padding-top: 80px !important;
      z-index: 200 !important;
      box-shadow: 2px 0 16px rgba(0,0,0,0.07) !important;
      transform: translateX(0) !important;
      transition: transform 0.3s ease !important;
      overflow-y: auto !important;
    }
    .side-nav.hidden { transform: translateX(-180px) !important; }
    .side-nav .nav-btn, .side-nav a.btn { display: flex; align-items: center; gap: 10px; padding: 12px 18px; background: none; border: none; color: #e0e7ef; text-decoration: none; font-size: 1em; border-radius: 0 20px 20px 0; transition: background 0.15s; cursor: pointer; margin-bottom: 2px; }
    .side-nav .nav-btn:hover, .side-nav a.btn:hover { background: #23263a; color: #fff; }
    .side-nav .nav-btn.active, .side-nav a.btn.active { background: #4f46e5; color: #fff; }
    
    /* Main Layout - FIXED */
    .app{
      display:grid;
      grid-template-columns:320px 1fr;
      gap:18px;
      height:100vh;
      padding:18px;
      margin-left: 180px !important;
      transition: margin-left 0.3s ease !important;
    }
    .app.expanded {
      margin-left: 0 !important;
    }

    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:14px;box-shadow:0 6px 20px rgba(2,6,23,0.6)}

    /* Sidebar */
    .sidebar{display:flex;flex-direction:column;gap:12px;overflow:hidden;}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#06b6d4);display:flex;align-items:center;justify-content:center;font-weight:700}
    h1{font-size:18px;margin:0}
    .muted{color:var(--muted);font-size:13px}
    .search{display:flex;gap:8px}
    .search input{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    .controls{display:flex;gap:8px}
    .btn{background:var(--accent);padding:8px 12px;border-radius:10px;border:none;color:white;cursor:pointer;transition:background .2s}
    .btn:hover{background:#4338ca}
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06)}
    .btn.secondary:hover{background:rgba(255,255,255,0.02)}

    /* lists */
    .list{overflow:auto;max-height:60vh;padding-right:6px}
    .list::-webkit-scrollbar{width:6px}
    .list::-webkit-scrollbar-track{background:transparent}
    .list::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:3px}
    .user-item{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;cursor:pointer;transition:background .2s}
    .user-item:hover{background:rgba(255,255,255,0.02)}
    .avatar{width:42px;height:42px;border-radius:10px;background:linear-gradient(135deg,#eab308,#ef4444);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:16px}
    .name{font-weight:600}
    .small{font-size:13px;color:var(--muted)}

    /* Main chat */
    .main{display:flex;flex-direction:column;gap:12px;overflow:hidden;}
    .chat-area{flex:1;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);padding:14px;border-radius:12px;overflow:auto;display:flex;flex-direction:column;gap:12px;max-height: calc(100vh - 200px);}
    .chat-area::-webkit-scrollbar{width:8px}
    .chat-area::-webkit-scrollbar-track{background:transparent}
    .chat-area::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:4px}
    .message-row{display:flex;align-items:flex-end;gap:10px}
    .message-row.mine{justify-content:flex-end}
    .bubble{max-width:66%;padding:10px 14px;border-radius:14px;line-height:1.3;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));box-shadow:0 6px 14px rgba(2,6,23,0.5);position:relative}
    .bubble.me{background:linear-gradient(180deg,var(--accent),#3b82f6);color:white}
    .bubble:after{content:"";position:absolute;width:12px;height:12px;bottom:6px;background:inherit;transform:rotate(45deg);}
    .message-row.mine .bubble:after{right:-6px}
    .message-row:not(.mine) .bubble:after{left:-6px}
    .meta{font-size:12px;color:var(--muted);margin-top:6px}

    .composer{display:flex;gap:8px;align-items:center;padding-top:12px;}
    .composer input{flex:1;padding:12px;border-radius:999px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    .composer input:focus{outline:none;border-color:var(--accent)}
    .small-action{font-size:12px;padding:6px 8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted);cursor:pointer;transition:all .2s}
    .small-action:hover{background:rgba(255,255,255,0.02);color:#fff}

    /* friend badges */
    .badge{background:rgba(255,255,255,0.06);padding:6px 8px;border-radius:999px;font-size:12px}

    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.8);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:1000}
    .modal{width:720px;max-width:90vw;background:linear-gradient(180deg, rgba(15,23,36,0.98), rgba(11,18,32,0.98));padding:24px;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.06)}
    .modal h3{margin:0 0 16px 0;font-size:20px}
    .modal h4{margin:0 0 12px 0;font-size:16px;color:var(--muted)}
    .modal input,.modal textarea{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:#fff;margin-bottom:12px}
    .modal input:focus,.modal textarea:focus{outline:none;border-color:var(--accent)}

    /* animations */
    .bubble{animation:pop .28s cubic-bezier(.2,.9,.2,1)}
    @keyframes pop{from{transform:translateY(6px) scale(.98);opacity:0}to{transform:none;opacity:1}}

    /* Responsive - FIXED */
    @media(max-width:900px){
      .app{
        grid-template-columns:1fr;
        grid-template-rows:auto 1fr;
        margin-left: 0 !important;
        padding: 80px 10px 10px 10px;
      }
      .sidebar{
        max-height:40vh;
        overflow-y: auto;
      }
      .main{
        max-height: calc(100vh - 50vh);
      }
      .side-nav {
        width: 250px !important;
        padding-top: 80px !important;
      }
      .side-nav.hidden { transform: translateX(-250px) !important; }
      .nav-toggle {
        left: 10px !important;
        top: 10px !important;
      }
    }

    /* RegentAI button states */
    #regentAiSendBtn:disabled, button[type="submit"]:disabled {
      background: linear-gradient(135deg,#6b46c1,#3730a3) !important;
      cursor: not-allowed;
      opacity: 0.6;
    }
    .sending {
      background: linear-gradient(135deg,#f59e0b,#d97706) !important;
      animation: pulse 1.5s ease-in-out infinite;
    }
    .success {
      background: linear-gradient(135deg,#10b981,#059669) !important;
      animation: successPulse 0.5s ease-in-out;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    @keyframes successPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
  </style>
</head>
<body>
  <!-- Navigation Toggle Button -->
  <button class="nav-toggle" id="navToggle">‚ò∞</button>
  
  <nav class="side-nav" id="sideNav">
    <button onclick="history.back()" class="nav-btn btn secondary" style="font-size:1.1em;">‚¨ÖÔ∏è Back</button>
    <a href="chat.html" class="btn secondary nav-btn active">üí¨ Chat</a>
    <a href="friends.html" class="btn secondary nav-btn">üë• Friends</a>
    <a href="groups.html" class="btn secondary nav-btn">üîó Groups</a>
    <a href="notifications.html" class="btn secondary nav-btn">üîî Notifications</a>
    <a href="profile.html" class="btn secondary nav-btn">üë§ Profile</a>
    <a href="settings.html" class="btn secondary nav-btn">‚öôÔ∏è Settings</a>
  </nav>

  <div class="app" id="appContainer">
    <aside class="card sidebar">
      <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap">
        <div class="muted">Current: <span id="currentShort" style="color:#fff">‚Äî</span></div>
        <div class="controls">
          <button class="btn secondary" id="btnProfile">Profile</button>
          <button class="btn secondary" id="btnLogout">Logout</button>
        </div>
      </div>

      <div class="card" style="padding:10px">
        <div style="display:flex;gap:8px;align-items:center">
          <input id="searchUsers" placeholder="Search users..." style="width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit" />
          <button class="small-action" id="btnClearSearch">Clear</button>
        </div>
      </div>

      <div class="card" style="flex:1;overflow:hidden;display:flex;flex-direction:column">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div class="muted">Registered Users</div>
          <div class="badge" id="usersCount">0</div>
        </div>
        <div class="list" id="usersList"></div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div class="muted">Friend Requests</div>
          <div class="badge" id="reqCount">0</div>
        </div>
        <div id="requestsList" class="list" style="max-height:150px"></div>
      </div>

      <div style="display:flex;gap:8px">
        <button class="btn" id="btnRegentAI" style="flex:1;background:linear-gradient(135deg,#8b5cf6,#4f46e5);display:flex;align-items:center;justify-content:center;gap:6px">
          <span>ü§ñ</span>
          <span>RegentAI</span>
        </button>
      </div>

      <div style="display:flex;gap:8px">
        <button class="btn" id="btnCreateGroup" style="flex:1">Create Group</button>
        <button class="btn secondary" id="btnViewGroups">Groups</button>
      </div>
    </aside>

    <main class="card main">
      <div class="chat-header">
        <div>
          <div id="chatTitle" style="font-size:18px;font-weight:600">No conversation selected</div>
          <div class="small" id="chatSubtitle">Select a friend or group to start chatting</div>
        </div>
        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
          <label class="small" style="cursor:pointer;user-select:none">
            Simulate AI replies
            <input type="checkbox" id="toggleAi" style="margin-left:8px;cursor:pointer">
          </label>
          <div class="muted">üíæ Saved locally</div>
        </div>
      </div>

      <div class="chat-area" id="chatArea"></div>

      <div class="composer">
        <input id="msgInput" placeholder="Type a message..." />
        <button class="btn" id="btnSend">Send</button>
      </div>
    </main>
  </div>

  <div id="modalRoot"></div>
  <div id="componentTemplates" style="display:none"></div>

  <!-- Load modules in correct order -->
  <script src="./js/db.js"></script>
  <script src="./js/auth.js"></script>
  <script src="./js/users.js"></script>
  <script src="./js/chat.js"></script>
  <script src="./js/groups.js"></script>
  <script src="./js/status.js"></script>
  <script src="./js/calls.js"></script>
  <script src="./js/ai.js"></script>
  <script src="./js/ui.js"></script>
  <script src="./js/app.js"></script>
  <script src="./js/components.js"></script>

  <script>
    // IMPORTANT: Run navigation toggle FIRST before any other code
    (function initNavToggle() {
      console.log('Initializing navigation toggle for chat page');
      
      const navToggle = document.getElementById('navToggle');
      const sideNav = document.getElementById('sideNav');
      const appContainer = document.getElementById('appContainer');
      
      if (!navToggle || !sideNav || !appContainer) {
        console.error('Navigation elements not found:', {navToggle, sideNav, appContainer});
        return;
      }
      
      console.log('Navigation elements found, attaching listener');
      
      navToggle.addEventListener('click', function() {
        console.log('Chat navigation toggle clicked');
        sideNav.classList.toggle('hidden');
        appContainer.classList.toggle('expanded');
        navToggle.textContent = sideNav.classList.contains('hidden') ? '‚ò∞' : '‚úï';
      });
      
      console.log('Navigation toggle initialized successfully');
    })();
    
    // Then run other initialization code
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM Content Loaded');
      /* Keys - Use KEYS from db.js */
      const KEY = KEYS;

      /* Seed sample users if none */
      function seed(){
        let users = DB.load(KEY.USERS,[]);
        if(users.length===0){
          users = [
            {id:uid(),name:'Philip',phone:'+233201234567',about:'Level 300 ‚Äî CS',avatarColor:'#ef4444'},
            {id:uid(),name:'Nana',phone:'+233245000123',about:'Robotics Club',avatarColor:'#f97316'},
            {id:uid(),name:'Akosua',phone:'+233244999888',about:'STEMAID',avatarColor:'#06b6d4'},
            {id:'bot_ai',name:'Regent AI',phone:'',about:'Simulated assistant',avatarColor:'#4f46e5'}
          ];
          DB.save(KEY.USERS,users);
        }
        if(!DB.load(KEY.MSGS)) DB.save(KEY.MSGS,[]);
        if(!DB.load(KEY.REQS)) DB.save(KEY.REQS,[]);
        if(!DB.load(KEY.GROUPS)) DB.save(KEY.GROUPS,[]);
      }
      seed();

      /* Utilities */
      function uid(prefix='u'){return prefix+Math.random().toString(36).slice(2,9)}
      function qs(sel,el=document){return el.querySelector(sel)}
      function qsa(sel,el=document){return Array.from(el.querySelectorAll(sel))}
      function timeNow(){return new Date().toISOString()}
      function convIdFor(u1,u2){const a=[u1,u2].sort();return `p_${a[0]}_${a[1]}`}

      /* App State - Load from DB using KEYS */
      let users = DB.load(KEYS.USERS,[]);
      let msgs = DB.load(KEYS.MESSAGES,[]);
      let reqs = DB.load(KEYS.REQUESTS,[]);
      let groups = DB.load(KEYS.GROUPS,[]);
      let currentUser = DB.load(KEYS.CURRENT_USER,null);
      let activeConv = null;

      /* DOM Elements */
      const usersList = qs('#usersList'), requestsList=qs('#requestsList'), usersCount=qs('#usersCount');
      const currentShort = qs('#currentShort'), chatTitle=qs('#chatTitle'), chatSubtitle=qs('#chatSubtitle');
      const chatArea = qs('#chatArea'), msgInput=qs('#msgInput'), btnSend=qs('#btnSend'), toggleAi=qs('#toggleAi');
      const reqCount = qs('#reqCount');

      function saveAll(){
        DB.save(KEYS.USERS,users);
        DB.save(KEYS.MESSAGES,msgs);
        DB.save(KEYS.REQUESTS,reqs);
        DB.save(KEYS.GROUPS,groups);
        DB.save(KEYS.CURRENT_USER,currentUser);
      }

      function renderUsers(filter=''){
        usersList.innerHTML='';
        const list = users.filter(u=>u.name.toLowerCase().includes(filter.toLowerCase()));
        usersCount.textContent = users.length;
        list.forEach(u=>{
          const isFriend = currentUser && u.friends && u.friends.includes(currentUser.id);
          const el=document.createElement('div');el.className='user-item';
          el.innerHTML=`<div class="avatar" style="background:${u.avatarColor || '#6ee7b7'}">${u.name.slice(0,2).toUpperCase()}</div>
            <div style="flex:1"><div class="name">${u.name} <span class="small">${u.id==='bot_ai'?'‚Ä¢ bot':isFriend?'‚Ä¢ friend':''}</span></div>
            <div class="small">${u.about||u.phone||'‚Äî'}</div></div>
            <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
              <button class="small-action" data-action="view" data-id="${u.id}">View</button>
              ${currentUser && currentUser.id !== u.id ? `<button class="btn" data-action="${isFriend?'message':'request'}" data-id="${u.id}" style="font-size:12px;padding:4px 8px">${isFriend?'Message':'Add'}</button>` : ''}
            </div>`;
          usersList.appendChild(el);
        })
      }

      function renderRequests(){
        requestsList.innerHTML='';
        const myReqs = currentUser ? reqs.filter(r=>r.to===currentUser.id) : [];
        reqCount.textContent = myReqs.length;
        if(myReqs.length === 0){
          requestsList.innerHTML = '<div class="muted" style="padding:8px;text-align:center">No pending requests</div>';
          return;
        }
        myReqs.forEach(r=>{
          const from = users.find(u=>u.id===r.from);
          if(!from) return;
          const el=document.createElement('div');el.className='user-item';
          el.innerHTML=`<div class="avatar" style="background:${from.avatarColor}">${from.name.slice(0,2).toUpperCase()}</div>
            <div style="flex:1"><div class="name">${from.name}</div><div class="small">${from.about||from.phone}</div></div>
            <div style="display:flex;gap:6px"><button class="btn" data-action="accept" data-id="${r.from}" style="font-size:12px;padding:4px 8px">Accept</button>
            <button class="small-action" data-action="reject" data-id="${r.from}">Reject</button></div>`;
          requestsList.appendChild(el);
        })
      }

      function updateCurrentUI(){currentShort.textContent = currentUser?currentUser.name:'‚Äî';}

      function init(){renderUsers();renderRequests();updateCurrentUI();renderChatArea();}
      init();

      /* Event delegations */
      usersList.addEventListener('click',e=>{
        const btn = e.target.closest('button'); if(!btn) return; const action = btn.dataset.action; const id=btn.dataset.id;
        const target = users.find(u=>u.id===id); if(!target) return;
        if(action==='view'){ openProfileModal(target) }
        if(action==='request'){ sendFriendRequest(id) }
        if(action==='message'){ startPrivateChat(id) }
      })

      requestsList.addEventListener('click',e=>{
        const btn=e.target.closest('button'); if(!btn) return; const action=btn.dataset.action; const id=btn.dataset.id;
        if(action==='accept') acceptRequest(id); if(action==='reject') rejectRequest(id);
      })

      qs('#btnOpenAuth').addEventListener('click',()=>openAuthModal());
      qs('#btnProfile').addEventListener('click',()=>{ if(!currentUser) return openAuthModal(); openEditProfile() });
      qs('#btnLogout').addEventListener('click',()=>{
        if(confirm('Are you sure you want to logout?')){
          localStorage.removeItem('rc_remember');
          DB.save(KEY.CUR, null);
          window.location.href = 'login.html';
        }
      });
      qs('#btnCreateGroup').addEventListener('click',()=>openCreateGroup());
      qs('#btnViewGroups').addEventListener('click',()=>openGroupsModal());
      qs('#searchUsers').addEventListener('input',e=>renderUsers(e.target.value));
      qs('#btnClearSearch').addEventListener('click',()=>{qs('#searchUsers').value='';renderUsers()});
      qs('#btnRegentAI').addEventListener('click',()=>{
        const aiBot = users.find(u => u.id === 'bot_ai');
        if(aiBot) {
          startPrivateChat('bot_ai');
        } else {
          alert('RegentAI is not available');
        }
      });

      /* Auth / Register */
      function openAuthModal(){
        const modal = document.createElement('div');modal.className='modal-backdrop'; modal.innerHTML=`
          <div class="modal card">
            <h3>üîê Login or Register</h3>
            <div style="display:flex;gap:16px;margin-top:16px">
              <div style="flex:1">
                <h4>Login</h4>
                <input id="loginId" placeholder="Your username or phone" />
                <button class="btn" id="doLogin" style="width:100%">Login</button>
              </div>
              <div style="flex:1">
                <h4>Register</h4>
                <input id="regName" placeholder="Full name" />
                <input id="regPhone" placeholder="Phone (optional)" />
                <button class="btn" id="doRegister" style="width:100%">Create account</button>
              </div>
            </div>
            <div style="display:flex;justify-content:flex-end;margin-top:16px"><button class="small-action" id="closeModal">Close</button></div>
          </div>`;
        qs('#modalRoot').appendChild(modal);
        qs('#closeModal',modal).addEventListener('click',()=>modal.remove());
        modal.addEventListener('click',e=>{ if(e.target === modal) modal.remove() });
        
        qs('#doRegister',modal).addEventListener('click',()=>{
          const name=qs('#regName',modal).value.trim(); const phone=qs('#regPhone',modal).value.trim();
          if(!name) return alert('Please enter a name');
          const u={id:uid(),name,phone,about:'',avatarColor:randomColor(),friends:[]}; 
          users.push(u); currentUser = u; saveAll(); modal.remove(); renderUsers(); renderRequests(); updateCurrentUI(); openEditProfile();
        })
        
        qs('#doLogin',modal).addEventListener('click',()=>{
          const key=qs('#loginId',modal).value.trim(); if(!key) return alert('Enter username or phone');
          const found = users.find(u=>u.name.toLowerCase()===key.toLowerCase()||u.phone===key||u.id===key);
          if(!found) return alert('No user found. Please register first.');
          currentUser=found; saveAll(); modal.remove(); updateCurrentUI(); renderUsers(); renderRequests();
        })
      }

      function openEditProfile(userId){
        const u = userId?users.find(x=>x.id===userId):currentUser; if(!u) return alert('No user');
        const modal=document.createElement('div');modal.className='modal-backdrop'; modal.innerHTML=`<div class="modal card">
          <h3>‚úèÔ∏è Profile ‚Äî ${u.name}</h3>
          <input id="pName" value="${u.name}" placeholder="Full name" />
          <input id="pPhone" value="${u.phone||''}" placeholder="Phone number" />
          <textarea id="pAbout" style="min-height:100px" placeholder="About / Bio">${u.about||''}</textarea>
          <div style="display:flex;justify-content:space-between;margin-top:12px">
            <button class="btn" id="saveProfile">üíæ Save</button>
            <button class="small-action" id="closeM">Close</button>
          </div>
        </div>`; qs('#modalRoot').appendChild(modal);
        qs('#closeM',modal).addEventListener('click',()=>modal.remove());
        modal.addEventListener('click',e=>{ if(e.target === modal) modal.remove() });
        
        qs('#saveProfile',modal).addEventListener('click',()=>{
          u.name = qs('#pName',modal).value.trim(); u.phone = qs('#pPhone',modal).value.trim(); u.about = qs('#pAbout',modal).value.trim();
          if(!u.name) return alert('Name cannot be empty');
          users = users.map(x=>x.id===u.id?u:x); 
          if(currentUser && currentUser.id===u.id) currentUser=u;
          saveAll(); modal.remove(); renderUsers(); updateCurrentUI();
        })
      }

      function openProfileModal(user){
        const modal=document.createElement('div');modal.className='modal-backdrop'; modal.innerHTML=`<div class="modal card">
          <div style="display:flex;gap:16px;align-items:center">
            <div class="avatar" style="background:${user.avatarColor};width:72px;height:72px;font-size:28px">${user.name.slice(0,2).toUpperCase()}</div>
            <div><h3 style="margin:0">${user.name}</h3><div class="small">${user.about||user.phone||'No bio'}</div></div>
          </div>
          <div style="display:flex;gap:8px;margin-top:16px">
            ${currentUser && currentUser.id !== user.id ? `<button class="btn" id="startChat">üí¨ Message</button>` : ''}
            <button class="small-action" id="closeQ">Close</button>
          </div>
        </div>`; qs('#modalRoot').appendChild(modal);
        qs('#closeQ',modal).addEventListener('click',()=>modal.remove());
        modal.addEventListener('click',e=>{ if(e.target === modal) modal.remove() });
        const chatBtn = qs('#startChat',modal);
        if(chatBtn) chatBtn.addEventListener('click',()=>{modal.remove(); startPrivateChat(user.id) });
      }

      /* Friend Requests - Updated to use Users module */
      function sendFriendRequest(toId){ 
        if(!currentUser) return alert('Please login or register first'); 
        
        const result = Users.sendFriendRequest(currentUser.id, toId);
        
        if(!result.ok) return alert(result.msg);
        
        // Reload data
        reqs = DB.load(KEY.REQS, []);
        renderRequests();
        alert('‚úÖ ' + result.msg);
      }

      function acceptRequest(fromId){ 
        if(!currentUser) return alert('Login first');
        
        // Find request ID
        const request = reqs.find(r => r.from === fromId && r.to === currentUser.id);
        if(!request) return alert('Request not found');
        
        const result = Users.acceptFriendRequest(request.id);
        
        if(!result.ok) return alert(result.msg);
        
        // Reload data
        users = DB.load(KEYS.USERS, []);
        currentUser = DB.load(KEYS.CURRENT_USER);
        reqs = DB.load(KEYS.REQUESTS, []);
        
        renderUsers();
        renderRequests();
        alert('‚úÖ ' + result.msg);
      }

      function rejectRequest(fromId){ 
        const request = reqs.find(r => r.from === fromId && r.to === currentUser.id);
        if(!request) return;
        
        Users.rejectFriendRequest(request.id);
        
        reqs = DB.load(KEYS.REQUESTS, []);
        renderRequests();
      }

      function isFriend(u1,u2){
        return Users.areFriends(u1, u2);
      }

      /* Chat */
      function startPrivateChat(otherId){ 
        if(!currentUser) return alert('Please login first');
        activeConv = {type:'private', id:convIdFor(currentUser.id,otherId), other:otherId}; 
        renderChatArea(); 
      }
      
      function startGroupChat(groupId){ 
        if(!currentUser) return alert('Please login first');
        activeConv = {type:'group', id:`group_${groupId}`, groupId}; 
        renderChatArea(); 
      }

      function renderChatArea(){ 
        chatArea.innerHTML=''; 
        if(!activeConv){ 
          chatTitle.textContent='No conversation selected'; 
          chatSubtitle.textContent='Select someone to chat with'; 
          return;
        }
        
        if(activeConv.type==='private'){
          const ids = activeConv.id.split('_').slice(1); 
          const other = ids.find(i=>i!==currentUser.id);
          const otherUser = users.find(u=>u.id===other) || {name:'Unknown'}; 
          chatTitle.textContent = 'üí¨ ' + otherUser.name; 
          chatSubtitle.textContent = otherUser.about||otherUser.phone||'Private conversation';
          
          // Add call buttons for private chats
          addCallButtons(other);
        } else {
          const gid = activeConv.groupId; 
          const g = groups.find(x=>x.id===gid) || {name:'Unknown',members:[]}; 
          chatTitle.textContent='üë• ' + g.name; 
          chatSubtitle.textContent=`Group ‚Ä¢ ${g.members.length} members`;
          
          // Add call button for group
          addGroupCallButton(gid);
        }
        
        const conversationMessages = msgs.filter(m=>m.convId===activeConv.id).sort((a,b)=>new Date(a.time)-new Date(b.time));
        
        if(conversationMessages.length === 0){
          const empty = document.createElement('div');
          empty.style.cssText = 'text-align:center;padding:40px;color:var(--muted)';
          empty.textContent = 'üëã Start the conversation by sending a message!';
          chatArea.appendChild(empty);
        } else {
          conversationMessages.forEach(m=>{
            const user = users.find(u=>u.id===m.from) || {name:'?'};
            const isMine = m.from === currentUser.id;
            
            // Use bubble renderer if available
            if(window.ChatBubbleRenderer) {
              const bubble = ChatBubbleRenderer.render({
                id: m.id,
                text: m.text,
                senderName: user.name,
                time: m.time,
                isMine: isMine,
                showSender: activeConv.type === 'group' && !isMine,
                status: m.status || 'read',
                attachment: m.attachment,
                attachmentType: m.attachmentType,
                attachmentName: m.attachmentName
              });
              chatArea.appendChild(bubble);
            } else {
              // Fallback to original rendering
              const el = document.createElement('div'); 
              el.className = 'message-row ' + (isMine?'mine':'');
              const bubble = document.createElement('div'); 
              bubble.className='bubble ' + (isMine? 'me':''); 
              bubble.innerHTML = `<div>${escapeHtml(m.text)}</div><div class="meta">${user.name} ‚Ä¢ ${new Date(m.time).toLocaleTimeString()}</div>`;
              el.appendChild(bubble); 
              chatArea.appendChild(el);
            }
          })
        }
        
        chatArea.scrollTop = chatArea.scrollHeight;
      }

      // Add call buttons to chat header
      function addCallButtons(userId) {
        const existingButtons = document.querySelector('.call-buttons');
        if(existingButtons) existingButtons.remove();
        
        const callButtons = document.createElement('div');
        callButtons.className = 'call-buttons';
        callButtons.style.cssText = 'display:flex;gap:8px;align-items:center';
        
        const btnCall = document.createElement('button');
        btnCall.className = 'btn secondary';
        btnCall.innerHTML = 'üìû Call';
        btnCall.onclick = () => startCall(userId);
        
        const btnVideoCall = document.createElement('button');
        btnVideoCall.className = 'btn secondary';
        btnVideoCall.innerHTML = 'üìπ Video Call';
        btnVideoCall.onclick = () => startVideoCall(userId);
        
        callButtons.appendChild(btnCall);
        callButtons.appendChild(btnVideoCall);
        
        chatHeader.appendChild(callButtons);
      }

      // Add group call button to chat header
      function addGroupCallButton(groupId) {
        const existingButton = document.querySelector('.group-call-button');
        if(existingButton) existingButton.remove();
        
        const btnGroupCall = document.createElement('button');
        btnGroupCall.className = 'btn secondary group-call-button';
        btnGroupCall.innerHTML = 'üìû Group Call';
        btnGroupCall.onclick = () => startGroupCall(groupId);
        
        chatHeader.appendChild(btnGroupCall);
      }

      // Fallback for call functions
      function startCall(userId) {
        alert('Starting a voice call with ' + userId);
      }
      function startVideoCall(userId) {
        alert('Starting a video call with ' + userId);
      }
      function startGroupCall(groupId) {
        alert('Starting a group call with group ' + groupId);
      }

      // Check if user is logged in, redirect if not
      if(!currentUser){
        window.location.href = 'login.html';
      } else {
        updateCurrentUI(); 
        renderUsers(); 
        renderRequests(); 
        renderChatArea();
        
        // Check if AI chat should be opened from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        if(urlParams.get('ai') === 'true') {
          const aiBot = users.find(u => u.id === 'bot_ai');
          if(aiBot) {
            setTimeout(() => {
              startPrivateChat('bot_ai');
            }, 100);
          }
        }
      }

      console.log('üöÄ Regent Connect Chat loaded successfully!');

      // Load chat bubble component
      async function loadChatBubbleComponent() {
        try {
          const response = await fetch('./components/chat-bubble.html');
          if (response.ok) {
            const html = await response.text();
            document.getElementById('componentTemplates').innerHTML = html;
            
            // Execute scripts
            const scripts = document.getElementById('componentTemplates').querySelectorAll('script');
            scripts.forEach(oldScript => {
              const newScript = document.createElement('script');
              newScript.textContent = oldScript.textContent;
              document.head.appendChild(newScript);
            });
          }
        } catch (error) {
          console.warn('Could not load chat bubble component, using fallback');
        }
      }

      // Initialize
      loadChatBubbleComponent();

      // Ensure Profile and Logout buttons work even if DOMContentLoaded timing is off
      function attachSidebarButtonHandlers() {
        var btnProfile = document.getElementById('btnProfile');
        if (btnProfile) btnProfile.onclick = function() {
          if (!currentUser) return openAuthModal();
          openEditProfile();
        };

        var btnLogout = document.getElementById('btnLogout');
        if (btnLogout) btnLogout.onclick = function() {
          if (confirm('Are you sure you want to logout?')) {
            localStorage.removeItem('rc_remember');
            DB.save(KEY.CUR, null);
            window.location.href = 'login.html';
          }
        };
      }

      // Attach handlers on DOMContentLoaded and after any dynamic sidebar rendering
      document.addEventListener('DOMContentLoaded', attachSidebarButtonHandlers);
      // Also call immediately in case DOM is already loaded
      attachSidebarButtonHandlers();
    });
  </script>

  <!-- Add RegentAI modal markup just before </body> -->
  <div id="regentAiModal" style="display:none;position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;">
    <div style="background:#181c2a;max-width:400px;width:95vw;border-radius:16px;box-shadow:0 8px 32px #000;padding:0 0 16px 0;display:flex;flex-direction:column;min-height:420px;max-height:90vh;">
      <div style="display:flex;align-items:center;gap:10px;padding:18px 18px 10px 18px;">
        <div style="width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,#8b5cf6,#4f46e5);display:flex;align-items:center;justify-content:center;font-size:22px;color:#fff;">ü§ñ</div>
        <div>
          <div style="font-weight:600;font-size:18px;">RegentAI</div>
          <div style="font-size:13px;color:#a3aed6;">Ask me anything about campus, study, or tech!</div>
        </div>
        <button onclick="closeRegentAiModal()" style="margin-left:auto;background:none;border:none;font-size:22px;color:#a3aed6;cursor:pointer;">&times;</button>
      </div>
      <div id="regentAiMessages" style="flex:1;overflow-y:auto;padding:0 18px 0 18px;display:flex;flex-direction:column;gap:12px;"></div>
      <form id="regentAiForm" style="display:flex;gap:8px;padding:12px 18px 0 18px;">
        <input id="regentAiInput" autocomplete="off" placeholder="Type your  question..." style="flex:1;padding:12px 14px;border-radius:8px;border:1px solid #353b50;background:#23263a;color:#fff;font-size:15px;" />
        <button type="submit" style="background:linear-gradient(135deg,#8b5cf6,#4f46e5);color:#fff;border:none;border-radius:8px;padding:0 18px;font-size:15px;font-weight:600;cursor:pointer;">Send</button>
      </form>
    </div>
  </div>
  <style>
    .ai-msg-user {align-self:flex-end;background:#4f46e5;color:#fff;padding:10px 14px;border-radius:10px;max-width:80%;font-size:15px;}
    .ai-msg-ai {align-self:flex-start;background:#23263a;color:#e0e7ef;padding:10px 14px;border-radius:10px;max-width:80%;font-size:15px;}
    @media (max-width:600px) {
      #regentAiModal > div {max-width:98vw;}
    }
  </style>
  <script>
    // RegentAI modal logic
    function openRegentAiModal() {
      document.getElementById('regentAiModal').style.display = 'flex';
      setTimeout(() => document.getElementById('regentAiInput').focus(), 200);
    }
    function closeRegentAiModal() {
      document.getElementById('regentAiModal').style.display = 'none';
    }
    // Attach to button
    document.getElementById('btnRegentAI').onclick = openRegentAiModal;
    document.getElementById('regentAiForm').onsubmit = async function(e) {
      e.preventDefault();
      const input = document.getElementById('regentAiInput');
      const sendBtn = document.getElementById('regentAiForm').querySelector('button[type="submit"]');
      const msg = input.value.trim();
      if(!msg) return;
      
      // Add button ID if not exists
      if(!sendBtn.id) sendBtn.id = 'regentAiSendBtn';
      
      // Disable button and show sending state
      sendBtn.disabled = true;
      sendBtn.classList.add('sending');
      const originalText = sendBtn.textContent;
      sendBtn.textContent = '...';
      
      addAiMessage(msg, 'user');
      input.value = '';
      addAiMessage('<span style="opacity:.6">RegentAI is typing...</span>', 'ai', true);
      
      let reply = await getFallbackAiReply(msg);
      const shouldSearchExternal = reply === "ü§ñ I'm here to help with campus, study, or tech questions! Ask me about Regent University, people, events, or anything else you'd like to know.";
      
      if (shouldSearchExternal) {
        reply = await searchExternalSources(msg);
      }
      
      removeAiTyping();
      addAiMessage(reply, 'ai');
      
      // Show success state
      sendBtn.classList.remove('sending');
      sendBtn.classList.add('success');
      sendBtn.textContent = '‚úì Sent';
      
      // Reset button
      setTimeout(() => {
        sendBtn.disabled = false;
        sendBtn.classList.remove('success');
        sendBtn.textContent = originalText;
      }, 1500);
    };
    function addAiMessage(text, who, isTyping) {
      const box = document.getElementById('regentAiMessages');
      const div = document.createElement('div');
      div.className = who === 'user' ? 'ai-msg-user' : 'ai-msg-ai';
      if(isTyping) div.style.opacity = '.7';
      div.dataset.typing = isTyping ? '1' : '';
      div.innerHTML = text;
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
    }
    function removeAiTyping() {
      const box = document.getElementById('regentAiMessages');
      const typing = box.querySelector('[data-typing="1"]');
      if(typing) typing.remove();
    }

    // RegentAI Knowledge Base - Enhanced with courses information
    window.RegentAI_KB = [
      {
        keywords: ['courses', 'programs', 'study', 'degree', 'what courses', 'what programs', 'majors', 'disciplines'],
        a: `üéì Regent University College of Science and Technology offers various programs including:\n\n<strong>Engineering & Technology:</strong>\n‚Ä¢ Computer Engineering\n‚Ä¢ Electrical & Electronics Engineering\n‚Ä¢ Mechanical Engineering\n‚Ä¢ Information Technology\n\n<strong>Business & Management:</strong>\n‚Ä¢ Business Administration\n‚Ä¢ Accounting\n‚Ä¢ Marketing\n‚Ä¢ Human Resource Management\n\n<strong>Sciences:</strong>\n‚Ä¢ Computer Science\n‚Ä¢ Applied Mathematics\n‚Ä¢ Data Science\n\nFor the complete list of programs, admission requirements, and course details, please visit <a href="https://regent.edu.gh" target="_blank" style="color:#8b5cf6;font-weight:600;">regent.edu.gh</a> üìö`
      }
    ];

    // Improved fallback to match keywords, not just exact regex
    async function getFallbackAiReply(msg) {
      if (window.RegentAI_KB) {
        const lowerMsg = msg.toLowerCase();
        for (const entry of RegentAI_KB) {
          if (entry.keywords.some(keyword => lowerMsg.includes(keyword))) {
            return entry.a;
          }
        }
      }
      const m = msg.toLowerCase();
      if(m.includes('how are you')||m.includes('how r u')||m.includes('how do you do')) {
        return "üòä I'm doing great, thank you for asking! Even though I'm not human, I'm here and ready to help you. How are you doing today?";
      }
      if(m.includes('fine')||m.includes('good')||m.includes('great')||m.includes('well')||m.includes('ok')||m.includes('okay')) {
        return "üòä That's wonderful to hear! How can I assist you today? Feel free to ask me about Regent University, campus life, or anything else!";
      }
      if(m.includes('not good')||m.includes('bad')||m.includes('sad')||m.includes('not well')) {
        return "üòî I'm sorry to hear that. I'm here if you need someone to talk to or if I can help with anything. What's on your mind?";
      }
      if(m.includes('hi')||m.includes('hello')||m.includes('hey')) return "üëã Hi there! How are you doing today? I'm RegentAI, your friendly campus assistant. Ask me anything!";
      if(m.includes('who are you')||m.includes('what are you')) return "ü§ñ I'm RegentAI, your virtual assistant for Regent University! I'm here to help you with information about campus, people, events, and more. I can also search external sources if needed. How can I help you today?";
      if(m.includes('thank')||m.includes('thanks')) return "üòä You're very welcome! Happy to help. Is there anything else you'd like to know?";
      if(m.includes('bye')||m.includes('goodbye')||m.includes('see you')) return "üëã Goodbye! Take care and have a wonderful day. Feel free to come back anytime you need help!";
      if(m.includes('project')) return "üöÄ Try building a web chat app using LocalStorage! It's a great learning project.";
      if(m.includes('club')) return "üéì There are many clubs at Regent: Robotics, Coding, Debate, and more! Which one interests you?";
      if(m.includes('exam')||m.includes('study')) return "üìö Study tip: Make a schedule, take regular breaks, and don't forget to stay hydrated! You've got this! üí™";
      return "ü§ñ I'm here to help with campus, study, or tech questions! Ask me about Regent University, people, events, or anything else you'd like to know.";
    }
  </script>
</body>
</html>
