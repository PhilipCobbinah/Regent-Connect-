<template id="tplMessage">
  <div class="chat-bubble" data-id="{{id}}">
    <div class="bubble-content">
      <div class="bubble-header" data-show-if="{{showSender}}">
        <span class="sender-name">{{senderName}}</span>
      </div>
      
      <div class="bubble-body">
        <p class="text">{{text}}</p>

        <!-- Attachment preview -->
        <div class="attachment" data-show-if="{{hasAttachment}}">
          <div class="attachment-preview">
            <img src="{{attachmentUrl}}" alt="attachment" class="attachment-image" data-show-if="{{isImage}}" />
            <video src="{{attachmentUrl}}" controls class="attachment-video" data-show-if="{{isVideo}}"></video>
            <div class="attachment-file" data-show-if="{{isFile}}">
              <span class="file-icon">ðŸ“„</span>
              <span class="file-name">{{attachmentName}}</span>
            </div>
          </div>
        </div>

        <!-- Quoted/Reply message -->
        <div class="quoted-message" data-show-if="{{hasQuote}}">
          <div class="quote-border"></div>
          <div class="quote-content">
            <span class="quote-sender">{{quoteSender}}</span>
            <span class="quote-text">{{quoteText}}</span>
          </div>
        </div>
      </div>

      <div class="bubble-footer">
        <time class="time">{{time}}</time>
        <span class="delivery-status" data-show-if="{{isMine}}">
          <span class="status-icon status-{{status}}">
            <span class="tick tick-1">âœ“</span>
            <span class="tick tick-2">âœ“</span>
          </span>
        </span>
      </div>
    </div>
  </div>
</template>

<style>
.chat-bubble {
  display: flex;
  margin-bottom: 12px;
  animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.chat-bubble.mine {
  justify-content: flex-end;
}

.bubble-content {
  max-width: 70%;
  padding: 10px 14px;
  border-radius: 14px;
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  box-shadow: 0 6px 14px rgba(2,6,23,0.5);
  position: relative;
}

.chat-bubble.mine .bubble-content {
  background: linear-gradient(180deg, var(--accent), #3b82f6);
  color: white;
  border-bottom-right-radius: 4px;
}

.chat-bubble:not(.mine) .bubble-content {
  border-bottom-left-radius: 4px;
}

/* Bubble tail */
.bubble-content::after {
  content: '';
  position: absolute;
  width: 12px;
  height: 12px;
  bottom: 6px;
  background: inherit;
  transform: rotate(45deg);
}

.chat-bubble.mine .bubble-content::after {
  right: -6px;
}

.chat-bubble:not(.mine) .bubble-content::after {
  left: -6px;
}

.bubble-header {
  font-size: 12px;
  font-weight: 600;
  margin-bottom: 4px;
  color: var(--accent);
}

.chat-bubble.mine .bubble-header {
  color: rgba(255,255,255,0.9);
}

.bubble-body {
  margin-bottom: 6px;
}

.text {
  margin: 0;
  line-height: 1.4;
  word-wrap: break-word;
}

/* Attachments */
.attachment {
  margin-top: 8px;
}

.attachment-preview {
  border-radius: 8px;
  overflow: hidden;
}

.attachment-image,
.attachment-video {
  max-width: 100%;
  border-radius: 8px;
  display: block;
}

.attachment-file {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px;
  background: rgba(0,0,0,0.2);
  border-radius: 8px;
}

.file-icon {
  font-size: 24px;
}

.file-name {
  font-size: 13px;
  flex: 1;
}

/* Quoted message */
.quoted-message {
  display: flex;
  gap: 8px;
  padding: 8px;
  margin-bottom: 8px;
  background: rgba(0,0,0,0.1);
  border-radius: 6px;
  font-size: 13px;
}

.quote-border {
  width: 3px;
  background: var(--accent);
  border-radius: 2px;
}

.quote-content {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.quote-sender {
  font-weight: 600;
  color: var(--accent);
}

.chat-bubble.mine .quote-sender {
  color: rgba(255,255,255,0.9);
}

.quote-text {
  opacity: 0.8;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  max-width: 200px;
}

/* Footer */
.bubble-footer {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  gap: 6px;
  font-size: 11px;
  color: var(--muted);
  margin-top: 4px;
}

.chat-bubble.mine .bubble-footer {
  color: rgba(255,255,255,0.7);
}

.delivery-status {
  display: flex;
  align-items: center;
}

.status-icon {
  display: inline-flex;
  gap: 1px;
}

.tick {
  font-size: 14px;
}

/* Status colors */
.status-sent .tick-2 {
  opacity: 0.3;
}

.status-delivered .tick {
  opacity: 1;
}

.status-read {
  color: #06b6d4;
}

.status-read .tick {
  opacity: 1;
}

/* Hidden elements */
[data-show-if="false"] {
  display: none !important;
}
</style>

<script>
/**
 * Chat Bubble Template Renderer
 * Simple template engine for message bubbles
 */
window.ChatBubbleRenderer = {
  /**
   * Render a message using the template
   */
  render(data) {
    const template = document.getElementById('tplMessage');
    if (!template) {
      console.error('Message template not found');
      return this.renderFallback(data);
    }

    let html = template.innerHTML;

    // Process conditionals
    const showIf = {
      hasAttachment: !!data.attachment,
      isImage: data.attachmentType === 'image',
      isVideo: data.attachmentType === 'video',
      isFile: data.attachmentType === 'file',
      hasQuote: !!data.quotedMessage,
      isMine: !!data.isMine,
      showSender: !data.isMine && data.showSender
    };

    // Replace placeholders
    const replacements = {
      id: data.id || '',
      text: this.escapeHtml(data.text || ''),
      senderName: this.escapeHtml(data.senderName || ''),
      time: this.formatTime(data.time),
      status: data.status || 'sent',
      attachmentUrl: data.attachment || '',
      attachmentName: data.attachmentName || 'File',
      quoteSender: this.escapeHtml(data.quoteSender || ''),
      quoteText: this.escapeHtml(data.quoteText || ''),
      ...showIf
    };

    // Replace all placeholders
    Object.entries(replacements).forEach(([key, value]) => {
      const regex = new RegExp(`{{${key}}}`, 'g');
      html = html.replace(regex, value);
    });

    // Create element
    const temp = document.createElement('div');
    temp.innerHTML = html;
    const bubble = temp.firstElementChild;

    // Add mine class
    if (data.isMine) {
      bubble.classList.add('mine');
    }

    // Remove hidden elements
    bubble.querySelectorAll('[data-show-if]').forEach(el => {
      if (el.getAttribute('data-show-if') === 'false') {
        el.remove();
      } else {
        el.removeAttribute('data-show-if');
      }
    });

    return bubble;
  },

  /**
   * Fallback renderer if template not found
   */
  renderFallback(data) {
    const bubble = document.createElement('div');
    bubble.className = 'message-row' + (data.isMine ? ' mine' : '');
    bubble.innerHTML = `
      <div class="bubble${data.isMine ? ' me' : ''}">
        <div>${this.escapeHtml(data.text)}</div>
        <div class="meta">${data.senderName} â€¢ ${this.formatTime(data.time)}</div>
      </div>
    `;
    return bubble;
  },

  /**
   * Format time
   */
  formatTime(timestamp) {
    if (!timestamp) return '';
    const date = new Date(timestamp);
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  },

  /**
   * Escape HTML
   */
  escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
};
</script>
